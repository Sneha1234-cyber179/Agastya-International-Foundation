<!-- templates/index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agastya International Foundation — Program Team</title>

  <!-- Bootstrap CSS (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
  <header class="bg-primary text-white py-3 mb-3">
    <div class="container">
      <h1 class="h3 mb-0">Agastya International Foundation</h1>
    </div>
  </header>

  <main class="container mb-5">
    <div class="row gx-4">
      <!-- Left: Form -->
      <div class="col-lg-5">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title text-primary">Enter Program Team Details</h5>

            <form id="entryForm" enctype="multipart/form-data">
              <div class="mb-2">
                <label class="form-label">Region</label>
                <select id="region" name="region" class="form-select" required>
                  <option value="">-- Select Region --</option>
                  <option>N1</option><option>N2</option><option>Gujarat</option><option>MH1</option><option>NK2</option><option>NK2SK1</option><option>SK2</option><option>Tamilnadu</option><option>APTS</option><option>Kupam</option>
                </select>
              </div>

              <div class="mb-2">
                <label class="form-label">Version</label>
                <select id="version" name="version" class="form-select" required>
                  <option value="">-- Select Version --</option>
                  <option>Actilearn 1.0</option><option>Actilearn Junior</option><option>Papertronics</option><option>ISEE</option><option>Financial Literacy</option><option>Plastic Smart</option><option>ClimateQuest</option><option>Chemagica</option>
                </select>
              </div>

              <div class="mb-2">
                <label class="form-label">Language</label>
                <select id="language" name="language" class="form-select" required>
                  <option value="">-- Select Language --</option>
                  <option>Hindi</option><option>English</option><option>Kannada</option><option>Tamil</option><option>Telugu</option><option>Malayalam</option><option>Marathi</option><option>Gujarati</option><option>Punjabi</option><option>Bengali</option><option>Odia</option><option>Urdu</option><option>Assamese</option><option>Konkani</option><option>Manipuri</option><option>Sanskrit</option>
                </select>
              </div>

              <div class="row gx-2">
                <div class="col-4 mb-2">
                  <label class="form-label">Quantity</label>
                  <input id="quantity" name="quantity" class="form-control" inputmode="numeric" required>
                </div>
                <div class="col-4 mb-2">
                  <label class="form-label">Grade</label>
                  <input id="grade" name="grade" class="form-control" inputmode="numeric" required>
                </div>
                <div class="col-4 mb-2">
                  <label class="form-label">Total</label>
                  <input id="total" name="total" class="form-control" inputmode="numeric" required>
                </div>
              </div>

              <div class="mb-2">
                <label class="form-label">POC Email</label>
                <input id="poc" name="poc" type="email" class="form-control" placeholder="example@gmail.com" required>
              </div>

              <div class="mb-3">
                <label class="form-label">LR file (optional)</label>
                <input id="lrfile" name="lrfile" type="file" class="form-control" accept=".png,.jpg,.jpeg,.webp,.gif,.pdf">
              </div>

              <div class="d-flex gap-2">
                <button id="saveBtn" type="submit" class="btn btn-primary">Save</button>
                <button id="updateBtn" class="btn btn-outline-success" disabled>Update</button>
                <button id="clearBtn" type="button" class="btn btn-light">Clear</button>
              </div>
              <input type="hidden" id="editId" name="editId" value="">
            </form>
            <div id="formMsg" class="mt-3"></div>
          </div>
        </div>
      </div>

      <!-- Right: Grid -->
      <div class="col-lg-7">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title text-primary">All Records</h5>
            <div class="table-responsive">
              <table id="recordsTable" class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>#</th><th>Region</th><th>Version</th><th>Language</th><th>Qty</th><th>Grade</th><th>Total</th><th>POC</th><th>LR</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div id="gridMsg" class="mt-2"></div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <footer class="text-center text-muted py-3">
    <small>© Agastya International Foundation</small>
  </footer>

  <!-- Bootstrap JS and optionally Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- App JS -->
  <script>
    const api = {
      records: "/api/records",
      save: "/api/save",
      updateBase: "/api/update/"   // append id
    };

    async function loadRecords() {
      const res = await fetch(api.records);
      const data = await res.json();
      if (!data.ok) { document.getElementById('gridMsg').innerText = "Failed to load records."; return; }
      const tbody = document.querySelector("#recordsTable tbody");
      tbody.innerHTML = "";
      data.records.forEach((r, idx) => {
        const tr = document.createElement("tr");
        tr.dataset.id = r.id;
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${escapeHtml(r.region)}</td>
          <td>${escapeHtml(r.version)}</td>
          <td>${escapeHtml(r.language)}</td>
          <td>${escapeHtml(r.quantity)}</td>
          <td>${escapeHtml(r.grade)}</td>
          <td>${escapeHtml(r.total)}</td>
          <td>${escapeHtml(r.poc)}</td>
          <td>${r.lr ? `<a href="${r.lr}" target="_blank">link</a>` : ""}</td>
        `;
        tr.addEventListener("click", () => { loadIntoForm(r); });
        tbody.appendChild(tr);
      });
    }

    function escapeHtml(s) {
      if (!s) return "";
      return s.replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;");
    }

    function setMessage(id, txt, isError=false) {
      const el = document.getElementById(id);
      el.innerHTML = txt;
      el.style.color = isError ? "crimson" : "green";
      setTimeout(()=> el.innerHTML = "", 5000);
    }

    function loadIntoForm(r) {
      document.getElementById("editId").value = r.id;
      document.getElementById("region").value = r.region || "";
      document.getElementById("version").value = r.version || "";
      document.getElementById("language").value = r.language || "";
      document.getElementById("quantity").value = r.quantity || "";
      document.getElementById("grade").value = r.grade || "";
      document.getElementById("total").value = r.total || "";
      document.getElementById("poc").value = r.poc || "";
      document.getElementById("updateBtn").disabled = false;
      window.scrollTo({top: 0, behavior: 'smooth'});
    }

    // Validate front-end
    function validateForm(formData) {
      if (!formData.get("region")) return "Region required";
      if (!formData.get("version")) return "Version required";
      if (!formData.get("language")) return "Language required";
      if (!/^\d+$/.test(formData.get("quantity") || "")) return "Quantity must be numeric";
      if (!/^\d+$/.test(formData.get("grade") || "")) return "Grade must be numeric";
      if (!/^\d+$/.test(formData.get("total") || "")) return "Total must be numeric";
      const email = formData.get("poc") || "";
      if (!/^[\w\.-]+@[\w\.-]+\.\w+$/.test(email)) return "Invalid POC email";
      return null;
    }

    // Save new record
    document.getElementById("entryForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      const err = validateForm(formData);
      if (err) { setMessage("formMsg", err, true); return; }
      const res = await fetch(api.save, { method:"POST", body: formData });
      const data = await res.json();
      if (!data.ok) { setMessage("formMsg", data.error || "Save failed", true); return; }
      setMessage("formMsg", "Saved successfully");
      form.reset();
      document.getElementById("updateBtn").disabled = true;
      loadRecords();
    });

    // Update existing
    document.getElementById("updateBtn").addEventListener("click", async (e) => {
      const id = document.getElementById("editId").value;
      if (!id) { setMessage("formMsg", "Select a row to update", true); return; }
      const formData = new FormData(document.getElementById("entryForm"));
      const err = validateForm(formData);
      if (err) { setMessage("formMsg", err, true); return; }
      const res = await fetch(api.updateBase + id, { method: "POST", body: formData });
      const data = await res.json();
      if (!data.ok) { setMessage("formMsg", data.error || "Update failed", true); return; }
      setMessage("formMsg", "Updated successfully");
      document.getElementById("entryForm").reset();
      document.getElementById("updateBtn").disabled = true;
      loadRecords();
    });

    // Clear
    document.getElementById("clearBtn").addEventListener("click", () => {
      document.getElementById("entryForm").reset();
      document.getElementById("editId").value = "";
      document.getElementById("updateBtn").disabled = true;
    });

    // Input digits-only behavior
    ["quantity","grade","total"].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener("keypress", (ev)=> {
        if (!/\d/.test(ev.key) && ev.key !== "Backspace" && ev.key !== "Enter" && ev.key !== "Tab") {
          ev.preventDefault();
          setMessage("formMsg", "Only numbers allowed for quantity/grade/total", true);
        }
      });
    });

    // load records at startup
    loadRecords();
  </script>
</body>
</html>
